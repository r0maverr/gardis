var jsGoogleCE={map:null,arData:null,obForm:null,currentView:"",bPositionFixed:true,bAddPointMode:false,bAddPolyMode:false,DblClickObserver:null,__arValidKeys:["google_lat","google_lon","google_scale","PLACEMARKS","LON","LAT","TEXT"],__currentPolyLine:null,__currentPolyLineObject:null,init:function(){BX.loadCSS("/bitrix/components/bitrix/map.google.system/templates/.default/style.css");jsGoogleCE.map=GLOBAL_arMapObjects.system_view_edit;jsGoogleCE.arData=arPositionData;jsGoogleCE.obForm=document.forms.bx_popup_form_google_map;jsGoogleCE.obForm.onsubmit=jsGoogleCE.__saveChanges;google.maps.event.addListener(jsGoogleCE.map,"dragend",jsGoogleCE.__getPositionValues);google.maps.event.addListener(jsGoogleCE.map,"maptypeid_changed",jsGoogleCE.__getPositionValues);if(!jsGoogleCE.arData.google_lat||!jsGoogleCE.arData.google_lon||!jsGoogleCE.arData.google_scale){var d=jsGoogleCE.map.getCenter();jsGoogleCE.arData.google_lat=d.lat();jsGoogleCE.arData.google_lon=d.lng();jsGoogleCE.arData.google_scale=jsGoogleCE.map.getZoom();jsGoogleCE.bPositionFixed=false}else{jsGoogleCE.arData.google_scale=parseInt(jsGoogleCE.arData.google_scale);jsGoogleCE.bPositionFixed=true}jsGoogleCE.setControlValue("google_lat",jsGoogleCE.arData.google_lat);jsGoogleCE.setControlValue("google_lon",jsGoogleCE.arData.google_lon);jsGoogleCE.setControlValue("google_scale",jsGoogleCE.arData.google_scale);jsGoogleCE.currentView=BX.message("google_current_view");jsGoogleCE.setControlValue("google_view",BX.message("google_MAP_VIEW_"+jsGoogleCE.map.getMapTypeId().toUpperCase()));if(BX.browser.IsIE()){var c=new google.maps.Marker({position:new google.maps.LatLng(90,0),map:jsGoogleCE.map})}if(jsGoogleCE.arData.PLACEMARKS&&jsGoogleCE.arData.PLACEMARKS.length>0){for(var b=0,a=jsGoogleCE.arData.PLACEMARKS.length;b<a;b++){jsGoogleCE.addCustomPoint(jsGoogleCE.arData.PLACEMARKS[b],b)}}BX("bx_restore_position").onclick=jsGoogleCE.restorePositionValues;BX("bx_google_map_controls").style.visibility="visible";BX("bx_google_map_address_search").style.visibility="visible"},__getPositionValues:function(){if(jsGoogleCE.bPositionFixed){return}var a=jsGoogleCE.map.getCenter();jsGoogleCE.arData.google_lat=a.lat();jsGoogleCE.arData.google_lon=a.lng();jsGoogleCE.arData.google_scale=jsGoogleCE.map.getZoom();jsGoogleCE.setControlValue("google_lat",jsGoogleCE.arData.google_lat);jsGoogleCE.setControlValue("google_lon",jsGoogleCE.arData.google_lon);jsGoogleCE.setControlValue("google_scale",jsGoogleCE.arData.google_scale);jsGoogleCE.currentView=jsGoogleCE.map.getMapTypeId().toUpperCase();jsGoogleCE.setControlValue("google_view",BX.message("google_MAP_VIEW_"+jsGoogleCE.currentView))},restorePositionValues:function(a){BX.PreventDefault(a);if(jsGoogleCE.currentView&&google.maps.MapTypeId[jsGoogleCE.currentView]){jsGoogleCE.map.setMapTypeId(google.maps.MapTypeId[jsGoogleCE.currentView])}jsGoogleCE.map.setZoom(jsGoogleCE.arData.google_scale);jsGoogleCE.map.panTo(new google.maps.LatLng(jsGoogleCE.arData.google_lat,jsGoogleCE.arData.google_lon))},setFixedFlag:function(a){jsGoogleCE.bPositionFixed=a;if(!a){jsGoogleCE.__getPositionValues()}},setControlValue:function(d,c){var b=jsGoogleCE.obForm["bx_"+d];if(null!=b){b.value=c}var a=BX("bx_"+d+"_value");if(null!=a){a.innerHTML=c}},__updatePointPosition:function(){if(null==this.BX_PLACEMARK_INDEX){return}var a=this.getPosition();jsGoogleCE.arData.PLACEMARKS[this.BX_PLACEMARK_INDEX].LON=a.lng();jsGoogleCE.arData.PLACEMARKS[this.BX_PLACEMARK_INDEX].LAT=a.lat()},addPoint:function(){if(jsGoogleCE.bAddPointMode){jsGoogleCE.bAddPointMode=false;jsGoogleCE.map.disableDoubleClickZoom=false;BX("bx_google_addpoint_link").style.display="block";BX("bx_google_addpoint_message").style.display="none";if(jsGoogleCE.DblClickObserver){google.maps.event.removeListener(jsGoogleCE.DblClickObserver)}}else{jsGoogleCE.bAddPointMode=true;jsGoogleCE.map.disableDoubleClickZoom=true;document.getElementById("bx_google_addpoint_link").style.display="none";document.getElementById("bx_google_addpoint_message").style.display="block";jsGoogleCE.DblClickObserver=google.maps.event.addListener(jsGoogleCE.map,"dblclick",jsGoogleCE.__addPoint)}},__openBalloon:function(a){if(null==a.infowin){a.infowin=new google.maps.InfoWindow({content:""})}a.infowin.setContent('<textarea onblur="jsGoogleCE.__updatePointView(this, \'blur\')" onkeyup="jsGoogleCE.__updatePointView(this, \'keyup\')" id="BX_PLACEMARK_TEXT_'+a.BX_PLACEMARK_INDEX+'" rows="4" style="resize:none;">'+BX.util.htmlspecialchars(jsGoogleCE.arData.PLACEMARKS[a.BX_PLACEMARK_INDEX].TEXT)+"</textarea>");a.infowin.open(jsGoogleCE.map,a);setTimeout(function(){try{BX("BX_PLACEMARK_TEXT_"+a.BX_PLACEMARK_INDEX).focus()}catch(b){}},500)},__pointClick:function(){jsGoogleCE.__openBalloon(this)},__createPlaceMark:function(d,c){if(null==jsGoogleCE.arData.PLACEMARKS){jsGoogleCE.arData.PLACEMARKS=[]}if(null==c){c=jsGoogleCE.arData.PLACEMARKS.length;jsGoogleCE.arData.PLACEMARKS[c]={TEXT:d.TEXT}}if(null!=d.POS){jsGoogleCE.arData.PLACEMARKS[c].LON=d.POS.lng();jsGoogleCE.arData.PLACEMARKS[c].LAT=d.POS.lat()}else{jsGoogleCE.arData.PLACEMARKS[c].LAT=d.LAT;jsGoogleCE.arData.PLACEMARKS[c].LON=d.LON}var b=jsGoogleCE.__createPointView();b.id="BX_PLACEMARK_"+c;var e=new google.maps.LatLng(jsGoogleCE.arData.PLACEMARKS[c].LAT,jsGoogleCE.arData.PLACEMARKS[c].LON);var f="";if(d.TEXT.length>0){var a=d.TEXT.indexOf("\n");f=a<=0?d.TEXT:d.TEXT.substring(0,a);f=BX.util.htmlspecialchars(f)}b.BXPlacemark=new google.maps.Marker({position:e,map:jsGoogleCE.map,draggable:true});b.BXPlacemark.BX_PLACEMARK_INDEX=c;b.BXPlacemark.BXTEXT="";if(null!=d.TEXT&&d.TEXT.length>0){b.BXPlacemark.BXTEXT=d.TEXT.replace(/\n/g,"<br />")}google.maps.event.addListener(b.BXPlacemark,"click",jsGoogleCE.__pointClick);google.maps.event.addListener(b.BXPlacemark,"dragend",jsGoogleCE.__updatePointPosition);jsGoogleCE.__updatePointViewText(b,f?f:BX.message("google_noname"));return b.BXPlacemark},addCustomPoint:function(a,b){jsGoogleCE.__createPlaceMark({TEXT:a.TEXT,LON:a.LON,LAT:a.LAT},b)},__addPoint:function(a){if(!jsGoogleCE.bAddPointMode){return}jsGoogleCE.__openBalloon(jsGoogleCE.__createPlaceMark({TEXT:"",POS:a.latLng}))},__point_link_hover:function(){this.style.backgroundColor="#E3E8F7";this.firstChild.style.display="block"},__point_link_hout:function(){this.style.backgroundColor="transparent";this.firstChild.style.display="none"},__createPointView:function(){var a=BX("bx_google_points").appendChild(BX.create("LI",{events:{mouseover:jsGoogleCE.__point_link_hover,mouseout:jsGoogleCE.__point_link_hout},children:[BX.create("A",{attrs:{href:"javascript: void(0)",className:"bx-google-delete"},events:{click:jsGoogleCE.__deletePoint},style:{display:"none"}}),BX.create("A",{attributes:{href:"javascript: void(0)",className:"bx-google-point"},events:{click:jsGoogleCE.__openPointBalloonFromView},html:BX.message("google_noname")})]}));return a},__deletePoint:function(b){BX.PreventDefault(b);var a=this.parentNode;jsGoogleCE.arData.PLACEMARKS[a.BXPlacemark.BX_PLACEMARK_INDEX].DELETED=1;if(a.BXPlacemark.infowin){a.BXPlacemark.infowin=null}a.BXPlacemark.setMap(null);this.parentNode.parentNode.removeChild(this.parentNode)},__updatePointViewText:function(a,b){a.firstChild.nextSibling.innerHTML=b;a.firstChild.nextSibling.style.margin="0 18px 0 0"},__openPointBalloonFromView:function(a){BX.PreventDefault(a);jsGoogleCE.__openBalloon(this.parentNode.BXPlacemark)},__updatePointView:function(c,e){var f=c.value;var b=c.id.substring(18);jsGoogleCE.arData.PLACEMARKS[b].TEXT=f;var a=f.indexOf("\n");var g="";if(f.length>0){g=a<=0?f:f.substring(0,a)}g=BX.util.htmlspecialchars(g);var d=document.getElementById("BX_PLACEMARK_"+b);jsGoogleCE.__updatePointViewText(d,g?g:BX.message("google_noname"));if(e=="blur"){d.BXPlacemark.infowin.close()}},__checkValidKey:function(c){if(Number(c)==c){return true}for(var b=0,a=jsGoogleCE.__arValidKeys.length;b<a;b++){if(jsGoogleCE.__arValidKeys[b]==c){return true}}return false},__serialize:function(d){if(typeof(d)=="object"){var f="",b=0;for(var a in d){if(jsGoogleCE.__checkValidKey(a)){++b;f+=jsGoogleCE.__serialize(a)+jsGoogleCE.__serialize(d[a])}}f="a:"+b+":{"+f+"}";return f}else{if(typeof(d)=="boolean"){return"b:"+(d?1:0)+";"}else{if(null==d){return"N;"}else{if(Number(d)==d&&d!=""&&d!=" "){if(Math.floor(d)==d){return"i:"+d+";"}else{return"d:"+d+";"}}else{if(typeof(d)=="string"){d=d.replace(/\r\n/g,"\n");d=d.replace(/\n/g,"###RN###");var e=0;if(window._global_BX_UTF){for(var c=0,b=d.length;c<b;c++){if(d.charCodeAt(c)>2047){e+=2}else{if(d.charCodeAt(c)>127){e++}}}}return"s:"+(d.length+e)+':"'+d+'";'}}}}}},__saveChanges:function(){if(!jsGoogleCE.map){return false}jsGoogleCE.bAddPointMode=false;if(jsGoogleCE.arData.PLACEMARKS){var c=[];for(var b=0,a=jsGoogleCE.arData.PLACEMARKS.length;b<a;b++){if(null==jsGoogleCE.arData.PLACEMARKS[b].DELETED){c[c.length]=jsGoogleCE.arData.PLACEMARKS[b]}}jsGoogleCE.arData.PLACEMARKS=c}window.jsGoogleCEOpener.saveData(jsGoogleCE.__serialize(jsGoogleCE.arData),jsGoogleCE.currentView);return false}};var jsGoogleCESearch={bInited:false,map:null,geocoder:null,obInput:null,timerID:null,timerDelay:1000,arSearchResults:[],obOut:null,__init:function(a){if(jsGoogleCESearch.bInited){return}jsGoogleCESearch.map=jsGoogleCE.map;jsGoogleCESearch.obInput=a;a.form.onsubmit=function(){jsGoogleCESearch.doSearch();return false};a.onfocus=jsGoogleCESearch.showResults;a.onblur=jsGoogleCESearch.hideResults;jsGoogleCESearch.bInited=true},setTypingStarted:function(a){if(!jsGoogleCESearch.bInited){jsGoogleCESearch.__init(a)}jsGoogleCESearch.hideResults();if(null!=jsGoogleCESearch.timerID){clearTimeout(jsGoogleCESearch.timerID)}jsGoogleCESearch.timerID=setTimeout(jsGoogleCESearch.doSearch,jsGoogleCESearch.timerDelay)},doSearch:function(){var a=jsUtils.trim(jsGoogleCESearch.obInput.value);if(a.length>1){if(null==jsGoogleCESearch.geocoder){jsGoogleCESearch.geocoder=new google.maps.Geocoder()}jsGoogleCESearch.geocoder.geocode({address:a,language:BX.message("LANGUAGE_ID")},jsGoogleCESearch.__searchResultsLoad)}},handleError:function(){alert(jsGoogleCE.jsMess.mess_error)},__generateOutput:function(){jsGoogleCESearch.obOut=document.body.appendChild(document.createElement("UL"));jsGoogleCESearch.obOut.className="bx-google-address-search-results";jsGoogleCESearch.obOut.style.display="none"},__searchResultsLoad:function(c,b){var h=jsGoogleCESearch;if(b!=google.maps.GeocoderStatus.OK&&b!=google.maps.GeocoderStatus.ZERO_RESULTS){h.handleError({message:b});return}if(!c){h.handleError()}else{if(null==h.obOut){h.__generateOutput()}h.obOut.innerHTML="";h.clearSearchResults();var a=0;if(b==google.maps.GeocoderStatus.OK){a=c.length;var g=null}if(a>0){for(var e=0;e<a;e++){h.arSearchResults[e]=c[e].geometry.location;var f="";for(var d=0;d<c[e].address_components.length;d++){f+=(f.length>0?", ":"")+c[e].address_components[d].long_name}h.obOut.appendChild(BX.create("LI",{attrs:{className:e==0?"bx-google-first":""},children:[BX.create("A",{attrs:{href:"javascript:void(0)"},props:{BXSearchIndex:e},events:{click:h.__showSearchResult},children:[BX.create("SPAN",{text:f})]})]}))}}else{h.obOut.innerHTML='<li class="bx-google-notfound">'+BX.message("google_nothing_found")+"</li>"}h.showResults()}},__showSearchResult:function(a){if(null!==this.BXSearchIndex){jsGoogleCESearch.map.panTo(jsGoogleCESearch.arSearchResults[this.BXSearchIndex])}return BX.PreventDefault(a)},showResults:function(){var a=jsUtils.GetRealPos(jsGoogleCESearch.obInput);jsGoogleCESearch.obOut.style.top=(a.bottom+2)+"px";jsGoogleCESearch.obOut.style.left=a.left+"px";jsGoogleCESearch.obOut.style.zIndex=parseInt(BX.WindowManager.Get().zIndex)+200;if(BX.findParent(jsGoogleCESearch.obInput,{tag:"div",className:"bx-core-window bx-core-adm-dialog"}).style.display=="block"){if(null!=jsGoogleCESearch.obOut){jsGoogleCESearch.obOut.style.display="block"}}},hideResults:function(){if(null!=jsGoogleCESearch.obOut){setTimeout("jsGoogleCESearch.obOut.style.display = 'none'",300)}},clearSearchResults:function(){for(var a=0;a<jsGoogleCESearch.arSearchResults.length;a++){delete jsGoogleCESearch.arSearchResults[a]}jsGoogleCESearch.arSearchResults=[]},clear:function(){if(!jsGoogleCESearch.bInited){return}jsGoogleCESearch.bInited=false;if(null!=jsGoogleCESearch.obOut){jsGoogleCESearch.obOut.parentNode.removeChild(jsGoogleCESearch.obOut);jsGoogleCESearch.obOut=null}jsGoogleCESearch.arSearchResults=[];jsGoogleCESearch.map=null;jsGoogleCESearch.geocoder=null;jsGoogleCESearch.obInput=null;jsGoogleCESearch.timerID=null}};