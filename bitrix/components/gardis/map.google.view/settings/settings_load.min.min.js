var jsGoogleCE={map:null,arData:null,obForm:null,currentView:"",bPositionFixed:true,bAddPointMode:false,bAddPolyMode:false,DblClickObserver:null,__arValidKeys:["google_lat","google_lon","google_scale","PLACEMARKS","LON","LAT","TEXT"],__currentPolyLine:null,__currentPolyLineObject:null,init:function(){BX.loadCSS("/bitrix/components/bitrix/map.google.system/templates/.default/style.css");jsGoogleCE.map=GLOBAL_arMapObjects.system_view_edit;jsGoogleCE.arData=arPositionData;jsGoogleCE.obForm=document.forms.bx_popup_form_google_map;jsGoogleCE.obForm.onsubmit=jsGoogleCE.__saveChanges;google.maps.event.addListener(jsGoogleCE.map,"dragend",jsGoogleCE.__getPositionValues);google.maps.event.addListener(jsGoogleCE.map,"maptypeid_changed",jsGoogleCE.__getPositionValues);if(!jsGoogleCE.arData.google_lat||!jsGoogleCE.arData.google_lon||!jsGoogleCE.arData.google_scale){var d=jsGoogleCE.map.getCenter();jsGoogleCE.arData.google_lat=d.lat();jsGoogleCE.arData.google_lon=d.lng();jsGoogleCE.arData.google_scale=jsGoogleCE.map.getZoom();jsGoogleCE.bPositionFixed=false}else{jsGoogleCE.arData.google_scale=parseInt(jsGoogleCE.arData.google_scale);jsGoogleCE.bPositionFixed=true}jsGoogleCE.setControlValue("google_lat",jsGoogleCE.arData.google_lat);jsGoogleCE.setControlValue("google_lon",jsGoogleCE.arData.google_lon);jsGoogleCE.setControlValue("google_scale",jsGoogleCE.arData.google_scale);jsGoogleCE.currentView=BX.message("google_current_view");jsGoogleCE.setControlValue("google_view",BX.message("google_MAP_VIEW_"+jsGoogleCE.map.getMapTypeId().toUpperCase()));if(BX.browser.IsIE()){var f=new google.maps.Marker({position:new google.maps.LatLng(90,0),map:jsGoogleCE.map})}if(jsGoogleCE.arData.PLACEMARKS&&jsGoogleCE.arData.PLACEMARKS.length>0){for(var c=0,b=jsGoogleCE.arData.PLACEMARKS.length;c<b;c++){jsGoogleCE.addCustomPoint(jsGoogleCE.arData.PLACEMARKS[c],c)}}BX("bx_restore_position").onclick=jsGoogleCE.restorePositionValues;BX("bx_google_map_controls").style.visibility="visible";BX("bx_google_map_address_search").style.visibility="visible"},__getPositionValues:function(){if(jsGoogleCE.bPositionFixed){return}var a=jsGoogleCE.map.getCenter();jsGoogleCE.arData.google_lat=a.lat();jsGoogleCE.arData.google_lon=a.lng();jsGoogleCE.arData.google_scale=jsGoogleCE.map.getZoom();jsGoogleCE.setControlValue("google_lat",jsGoogleCE.arData.google_lat);jsGoogleCE.setControlValue("google_lon",jsGoogleCE.arData.google_lon);jsGoogleCE.setControlValue("google_scale",jsGoogleCE.arData.google_scale);jsGoogleCE.currentView=jsGoogleCE.map.getMapTypeId().toUpperCase();jsGoogleCE.setControlValue("google_view",BX.message("google_MAP_VIEW_"+jsGoogleCE.currentView))},restorePositionValues:function(a){BX.PreventDefault(a);if(jsGoogleCE.currentView&&google.maps.MapTypeId[jsGoogleCE.currentView]){jsGoogleCE.map.setMapTypeId(google.maps.MapTypeId[jsGoogleCE.currentView])}jsGoogleCE.map.setZoom(jsGoogleCE.arData.google_scale);jsGoogleCE.map.panTo(new google.maps.LatLng(jsGoogleCE.arData.google_lat,jsGoogleCE.arData.google_lon))},setFixedFlag:function(a){jsGoogleCE.bPositionFixed=a;if(!a){jsGoogleCE.__getPositionValues()}},setControlValue:function(d,f){var c=jsGoogleCE.obForm["bx_"+d];if(null!=c){c.value=f}var b=BX("bx_"+d+"_value");if(null!=b){b.innerHTML=f}},__updatePointPosition:function(){if(null==this.BX_PLACEMARK_INDEX){return}var a=this.getPosition();jsGoogleCE.arData.PLACEMARKS[this.BX_PLACEMARK_INDEX].LON=a.lng();jsGoogleCE.arData.PLACEMARKS[this.BX_PLACEMARK_INDEX].LAT=a.lat()},addPoint:function(){if(jsGoogleCE.bAddPointMode){jsGoogleCE.bAddPointMode=false;jsGoogleCE.map.disableDoubleClickZoom=false;BX("bx_google_addpoint_link").style.display="block";BX("bx_google_addpoint_message").style.display="none";if(jsGoogleCE.DblClickObserver){google.maps.event.removeListener(jsGoogleCE.DblClickObserver)}}else{jsGoogleCE.bAddPointMode=true;jsGoogleCE.map.disableDoubleClickZoom=true;document.getElementById("bx_google_addpoint_link").style.display="none";document.getElementById("bx_google_addpoint_message").style.display="block";jsGoogleCE.DblClickObserver=google.maps.event.addListener(jsGoogleCE.map,"dblclick",jsGoogleCE.__addPoint)}},__openBalloon:function(a){if(null==a.infowin){a.infowin=new google.maps.InfoWindow({content:""})}a.infowin.setContent('<textarea onblur="jsGoogleCE.__updatePointView(this, \'blur\')" onkeyup="jsGoogleCE.__updatePointView(this, \'keyup\')" id="BX_PLACEMARK_TEXT_'+a.BX_PLACEMARK_INDEX+'" rows="4" style="resize:none;">'+BX.util.htmlspecialchars(jsGoogleCE.arData.PLACEMARKS[a.BX_PLACEMARK_INDEX].TEXT)+"</textarea>");a.infowin.open(jsGoogleCE.map,a);setTimeout(function(){try{BX("BX_PLACEMARK_TEXT_"+a.BX_PLACEMARK_INDEX).focus()}catch(b){}},500)},__pointClick:function(){jsGoogleCE.__openBalloon(this)},__createPlaceMark:function(g,h){if(null==jsGoogleCE.arData.PLACEMARKS){jsGoogleCE.arData.PLACEMARKS=[]}if(null==h){h=jsGoogleCE.arData.PLACEMARKS.length;jsGoogleCE.arData.PLACEMARKS[h]={TEXT:g.TEXT}}if(null!=g.POS){jsGoogleCE.arData.PLACEMARKS[h].LON=g.POS.lng();jsGoogleCE.arData.PLACEMARKS[h].LAT=g.POS.lat()}else{jsGoogleCE.arData.PLACEMARKS[h].LAT=g.LAT;jsGoogleCE.arData.PLACEMARKS[h].LON=g.LON}var c=jsGoogleCE.__createPointView();c.id="BX_PLACEMARK_"+h;var b=new google.maps.LatLng(jsGoogleCE.arData.PLACEMARKS[h].LAT,jsGoogleCE.arData.PLACEMARKS[h].LON);var d="";if(g.TEXT.length>0){var f=g.TEXT.indexOf("\n");d=f<=0?g.TEXT:g.TEXT.substring(0,f);d=BX.util.htmlspecialchars(d)}c.BXPlacemark=new google.maps.Marker({position:b,map:jsGoogleCE.map,draggable:true});c.BXPlacemark.BX_PLACEMARK_INDEX=h;c.BXPlacemark.BXTEXT="";if(null!=g.TEXT&&g.TEXT.length>0){c.BXPlacemark.BXTEXT=g.TEXT.replace(/\n/g,"<br />")}google.maps.event.addListener(c.BXPlacemark,"click",jsGoogleCE.__pointClick);google.maps.event.addListener(c.BXPlacemark,"dragend",jsGoogleCE.__updatePointPosition);jsGoogleCE.__updatePointViewText(c,d?d:BX.message("google_noname"));return c.BXPlacemark},addCustomPoint:function(a,b){jsGoogleCE.__createPlaceMark({TEXT:a.TEXT,LON:a.LON,LAT:a.LAT},b)},__addPoint:function(a){if(!jsGoogleCE.bAddPointMode){return}jsGoogleCE.__openBalloon(jsGoogleCE.__createPlaceMark({TEXT:"",POS:a.latLng}))},__point_link_hover:function(){this.style.backgroundColor="#E3E8F7";this.firstChild.style.display="block"},__point_link_hout:function(){this.style.backgroundColor="transparent";this.firstChild.style.display="none"},__createPointView:function(){var a=BX("bx_google_points").appendChild(BX.create("LI",{events:{mouseover:jsGoogleCE.__point_link_hover,mouseout:jsGoogleCE.__point_link_hout},children:[BX.create("A",{attrs:{href:"javascript: void(0)",className:"bx-google-delete"},events:{click:jsGoogleCE.__deletePoint},style:{display:"none"}}),BX.create("A",{attributes:{href:"javascript: void(0)",className:"bx-google-point"},events:{click:jsGoogleCE.__openPointBalloonFromView},html:BX.message("google_noname")})]}));return a},__deletePoint:function(a){BX.PreventDefault(a);var b=this.parentNode;jsGoogleCE.arData.PLACEMARKS[b.BXPlacemark.BX_PLACEMARK_INDEX].DELETED=1;if(b.BXPlacemark.infowin){b.BXPlacemark.infowin=null}b.BXPlacemark.setMap(null);this.parentNode.parentNode.removeChild(this.parentNode)},__updatePointViewText:function(a,b){a.firstChild.nextSibling.innerHTML=b;a.firstChild.nextSibling.style.margin="0 18px 0 0"},__openPointBalloonFromView:function(a){BX.PreventDefault(a);jsGoogleCE.__openBalloon(this.parentNode.BXPlacemark)},__updatePointView:function(h,i){var c=h.value;var b=h.id.substring(18);jsGoogleCE.arData.PLACEMARKS[b].TEXT=c;var d=c.indexOf("\n");var f="";if(c.length>0){f=d<=0?c:c.substring(0,d)}f=BX.util.htmlspecialchars(f);var g=document.getElementById("BX_PLACEMARK_"+b);jsGoogleCE.__updatePointViewText(g,f?f:BX.message("google_noname"));if(i=="blur"){g.BXPlacemark.infowin.close()}},__checkValidKey:function(b){if(Number(b)==b){return true}for(var c=0,a=jsGoogleCE.__arValidKeys.length;c<a;c++){if(jsGoogleCE.__arValidKeys[c]==b){return true}}return false},__serialize:function(g){if(typeof g=="object"){var h="",c=0;for(var b in g){if(jsGoogleCE.__checkValidKey(b)){++c;h+=jsGoogleCE.__serialize(b)+jsGoogleCE.__serialize(g[b])}}h="a:"+c+":{"+h+"}";return h}else{if(typeof g=="boolean"){return"b:"+(g?1:0)+";"}else{if(null==g){return"N;"}else{if(Number(g)==g&&g!=""&&g!=" "){if(Math.floor(g)==g){return"i:"+g+";"}else{return"d:"+g+";"}}else{if(typeof g=="string"){g=g.replace(/\r\n/g,"\n");g=g.replace(/\n/g,"###RN###");var d=0;if(window._global_BX_UTF){for(var f=0,c=g.length;f<c;f++){if(g.charCodeAt(f)>2047){d+=2}else{if(g.charCodeAt(f)>127){d++}}}}return"s:"+(g.length+d)+':"'+g+'";'}}}}}},__saveChanges:function(){if(!jsGoogleCE.map){return false}jsGoogleCE.bAddPointMode=false;if(jsGoogleCE.arData.PLACEMARKS){var b=[];for(var c=0,a=jsGoogleCE.arData.PLACEMARKS.length;c<a;c++){if(null==jsGoogleCE.arData.PLACEMARKS[c].DELETED){b[b.length]=jsGoogleCE.arData.PLACEMARKS[c]}}jsGoogleCE.arData.PLACEMARKS=b}window.jsGoogleCEOpener.saveData(jsGoogleCE.__serialize(jsGoogleCE.arData),jsGoogleCE.currentView);return false}};var jsGoogleCESearch={bInited:false,map:null,geocoder:null,obInput:null,timerID:null,timerDelay:1000,arSearchResults:[],obOut:null,__init:function(a){if(jsGoogleCESearch.bInited){return}jsGoogleCESearch.map=jsGoogleCE.map;jsGoogleCESearch.obInput=a;a.form.onsubmit=function(){jsGoogleCESearch.doSearch();return false};a.onfocus=jsGoogleCESearch.showResults;a.onblur=jsGoogleCESearch.hideResults;jsGoogleCESearch.bInited=true},setTypingStarted:function(a){if(!jsGoogleCESearch.bInited){jsGoogleCESearch.__init(a)}jsGoogleCESearch.hideResults();if(null!=jsGoogleCESearch.timerID){clearTimeout(jsGoogleCESearch.timerID)}jsGoogleCESearch.timerID=setTimeout(jsGoogleCESearch.doSearch,jsGoogleCESearch.timerDelay)},doSearch:function(){var a=jsUtils.trim(jsGoogleCESearch.obInput.value);if(a.length>1){if(null==jsGoogleCESearch.geocoder){jsGoogleCESearch.geocoder=new google.maps.Geocoder}jsGoogleCESearch.geocoder.geocode({address:a,language:BX.message("LANGUAGE_ID")},jsGoogleCESearch.__searchResultsLoad)}},handleError:function(){alert(jsGoogleCE.jsMess.mess_error)},__generateOutput:function(){jsGoogleCESearch.obOut=document.body.appendChild(document.createElement("UL"));jsGoogleCESearch.obOut.className="bx-google-address-search-results";jsGoogleCESearch.obOut.style.display="none"},__searchResultsLoad:function(h,i){var c=jsGoogleCESearch;if(i!=google.maps.GeocoderStatus.OK&&i!=google.maps.GeocoderStatus.ZERO_RESULTS){c.handleError({message:i});return}if(!h){c.handleError()}else{if(null==c.obOut){c.__generateOutput()}c.obOut.innerHTML="";c.clearSearchResults();var b=0;if(i==google.maps.GeocoderStatus.OK){b=h.length;var d=null}if(b>0){for(var f=0;f<b;f++){c.arSearchResults[f]=h[f].geometry.location;var g="";for(var j=0;j<h[f].address_components.length;j++){g+=(g.length>0?", ":"")+h[f].address_components[j].long_name}c.obOut.appendChild(BX.create("LI",{attrs:{className:f==0?"bx-google-first":""},children:[BX.create("A",{attrs:{href:"javascript:void(0)"},props:{BXSearchIndex:f},events:{click:c.__showSearchResult},children:[BX.create("SPAN",{text:g})]})]}))}}else{c.obOut.innerHTML='<li class="bx-google-notfound">'+BX.message("google_nothing_found")+"</li>"}c.showResults()}},__showSearchResult:function(a){if(null!==this.BXSearchIndex){jsGoogleCESearch.map.panTo(jsGoogleCESearch.arSearchResults[this.BXSearchIndex])}return BX.PreventDefault(a)},showResults:function(){var a=jsUtils.GetRealPos(jsGoogleCESearch.obInput);jsGoogleCESearch.obOut.style.top=a.bottom+2+"px";jsGoogleCESearch.obOut.style.left=a.left+"px";jsGoogleCESearch.obOut.style.zIndex=parseInt(BX.WindowManager.Get().zIndex)+200;if(BX.findParent(jsGoogleCESearch.obInput,{tag:"div",className:"bx-core-window bx-core-adm-dialog"}).style.display=="block"){if(null!=jsGoogleCESearch.obOut){jsGoogleCESearch.obOut.style.display="block"}}},hideResults:function(){if(null!=jsGoogleCESearch.obOut){setTimeout("jsGoogleCESearch.obOut.style.display = 'none'",300)}},clearSearchResults:function(){for(var a=0;a<jsGoogleCESearch.arSearchResults.length;a++){delete jsGoogleCESearch.arSearchResults[a]}jsGoogleCESearch.arSearchResults=[]},clear:function(){if(!jsGoogleCESearch.bInited){return}jsGoogleCESearch.bInited=false;if(null!=jsGoogleCESearch.obOut){jsGoogleCESearch.obOut.parentNode.removeChild(jsGoogleCESearch.obOut);jsGoogleCESearch.obOut=null}jsGoogleCESearch.arSearchResults=[];jsGoogleCESearch.map=null;jsGoogleCESearch.geocoder=null;jsGoogleCESearch.obInput=null;jsGoogleCESearch.timerID=null}};